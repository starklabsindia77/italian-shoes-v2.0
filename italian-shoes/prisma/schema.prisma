// prisma/schema.prisma
// PostgreSQL + Prisma 5.x

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/* ============================
   Enums
   ============================ */
enum Role {
  USER
  ADMIN
}

enum Currency {
  USD
  EUR
  GBP
}

enum Region {
  US
  EU
  UK
}

enum PanelGroup {
  FRONT
  SIDE
  BACK
  TOP
  SOLE
  LINING
}

enum OrderStatus {
  DESIGN_RECEIVED
  IN_PRODUCTION
  QUALITY_CHECK
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  IN_PRODUCTION
  READY_TO_SHIP
  SHIPPED
  DELIVERED
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum ShoeWidth {
  STANDARD
  WIDE
  EXTRA_WIDE
  NARROW
}

enum OptionType {
  SIZE
  WIDTH
  STYLE
  SOLE
  COLOR
  MATERIAL
  CUSTOM
}

/* ============================
   Auth (NextAuth v5 compatible)
   ============================ */
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?

  role          Role      @default(USER)

  accounts      Account[]
  sessions      Session[]
  orders        Order[]   @relation("UserOrders")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/* ============================
   Master Data
   ============================ */
model Material {
  id          String          @id @default(cuid())
  materialId  String          @unique           // e.g., "leather"
  name        String
  description String?
  category    String          // leather | suede | fabric | etc.
  isActive    Boolean         @default(true)
  extId       Int?

  colors      MaterialColor[]

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model MaterialColor {
  id          String    @id @default(cuid())
  materialId  String
  name        String                      // e.g., "White Oxford"
  colorCode   String?                     // slug/code
  family      String?                     // JSON "type" (White/Black/Brown)
  hexCode     String?
  imageUrl    String?
  isActive    Boolean   @default(true)
  extId       Int?

  material    Material  @relation(fields: [materialId], references: [id], onDelete: Cascade)
  panelColors ProductPanelColor[]

  @@index([materialId])
  @@index([name])
}

model Style {
  id          String   @id @default(cuid())
  styleId     String   @unique           // e.g., "cap-toe"
  name        String
  description String?
  category    String?
  isActive    Boolean   @default(true)
  imageUrl    String?                    // styles[].imageUrl

  glbUrl      String?                    // styles[].assets.glb
  lighting    Json?
  environment Json?
  assets      Json?                      // raw assets blob

  products    ProductStyle[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Sole {
  id          String   @id @default(cuid())
  soleId      String   @unique
  name        String
  description String?
  category    String?
  isActive    Boolean   @default(true)
  imageUrl    String?                    // soles[].imageUrl

  glbUrl      String?                    // soles[].assets.glb
  lighting    Json?
  environment Json?
  assets      Json?

  products    ProductSole[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Size {
  id            String  @id @default(cuid())
  sizeId        String  @unique           // e.g., "us-8"
  name          String                    // display "8"
  region        Region
  value         Float
  euEquivalent  String?
  ukEquivalent  String?
  isActive      Boolean @default(true)
  sortOrder     Int     @default(0)
  extId         Int?

  productSizes  ProductSize[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Panel {
  id        String     @id @default(cuid())
  panelId   String     @unique           // e.g., "toe-cap"
  name      String
  group     PanelGroup?
  sortOrder Int        @default(0)
  isActive  Boolean    @default(true)

  productPanels ProductPanel[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

/* ============================
   Product Catalog (JSON-aligned)
   ============================ */
model Product {
  id                   String    @id @default(cuid())

  // JSON uses "id": "oxford-001" as slug/key
  productId            String    @unique

  title                String
  vendor               String?
  description          String

  // SEO — from meta_* fields
  metaTitle            String
  metaDescription      String
  metaKeywords         String
  metaImage            String
  metaImageWidth       Int?
  metaImageHeight      Int?
  metaImageAlt         String?
  metaImageTitle       String?
  metaImageDescription String?

  // Pricing
  price                Int
  currency             Currency   @default(USD)
  compareAtPrice       Int?

  // Assets blob: { glb: { url, lighting, environment } }
  assets               Json?

  isActive             Boolean    @default(true)

  // Relations
  images               ProductImage[]
  panels               ProductPanel[]
  styles               ProductStyle[]
  soles                ProductSole[]
  sizes                ProductSize[]
  // Variants / Attributes
  options              ProductOption[]
  variants             ProductVariant[]

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([title])
  @@index([productId])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int      @default(0)

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductStyle {
  id        String @id @default(cuid())
  productId String
  styleId   String

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  style     Style   @relation(fields: [styleId], references: [id], onDelete: Restrict)

  @@unique([productId, styleId])
  @@index([styleId])
}

model ProductSole {
  id        String @id @default(cuid())
  productId String
  soleId    String

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  sole      Sole    @relation(fields: [soleId], references: [id], onDelete: Restrict)

  @@unique([productId, soleId])
  @@index([soleId])
}

/* Product-scoped sizes with width */
model ProductSize {
  id        String    @id @default(cuid())
  productId String
  sizeId    String
  width     ShoeWidth @default(STANDARD)

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  size      Size      @relation(fields: [sizeId], references: [id], onDelete: Restrict)

  @@unique([productId, sizeId, width])
  @@index([sizeId])
}

/* Panels & allowed colors per product */
model ProductPanel {
  id                      String   @id @default(cuid())
  productId               String
  panelId                 String
  isCustomizable          Boolean  @default(true)
  modelUrl                String?

  defaultMaterialColorId  String?

  product                 Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  panel                   Panel           @relation(fields: [panelId], references: [id], onDelete: Restrict)
  defaultMaterialColor    MaterialColor?  @relation(fields: [defaultMaterialColorId], references: [id])

  allowedColors           ProductPanelColor[]

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([productId, panelId], name: "productId_panelId")
  @@index([panelId])
}

model ProductPanelColor {
  id              String         @id @default(cuid())
  productPanelId  String
  materialColorId String

  productPanel    ProductPanel   @relation(fields: [productPanelId], references: [id], onDelete: Cascade)
  materialColor   MaterialColor  @relation(fields: [materialColorId], references: [id], onDelete: Restrict)

  @@unique([productPanelId, materialColorId])
  @@index([materialColorId])
}

/* ============================
   Attributes & Variations
   ============================ */
model ProductOption {
  id         String     @id @default(cuid())
  productId  String
  code       String                      // "size" | "style" | "sole" | "color" | ...
  name       String                      // "Size", "Style", ...
  type       OptionType @default(CUSTOM)
  position   Int        @default(0)
  isActive   Boolean    @default(true)
  metadata   Json?

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  values     ProductOptionValue[]
  variantOptions ProductVariantOption[]

  @@unique([productId, code])
  @@index([productId])
}

model ProductOptionValue {
  id               String       @id @default(cuid())
  productOptionId  String
  value            String                      // canonical value/slug (e.g., "8", "cap-toe", "sole-01", "mc_123")
  label            String                      // display label
  position         Int          @default(0)
  isActive         Boolean      @default(true)
  metadata         Json?
  // optional links to masters
  sizeId           String?
  styleId          String?
  soleId           String?
  materialColorId  String?
  width            ShoeWidth?

  productOption    ProductOption @relation(fields: [productOptionId], references: [id], onDelete: Cascade)

  @@unique([productOptionId, value])          // upsert by option+value
  @@index([productOptionId])
  @@index([materialColorId])
  @@index([sizeId])
  @@index([styleId])
  @@index([soleId])
}

model ProductVariant {
  id           String   @id @default(cuid())
  productId    String
  sku          String   @unique
  barcode      String?  @unique
  isActive     Boolean  @default(true)

  price        Int
  currency     Currency @default(USD)
  compareAt    Int?
  stockQty     Int?
  weightGrams  Int?
  imageUrl     String?
  metadata     Json?

  optionsHash  String   @unique              // deterministic from option value IDs

  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  options      ProductVariantOption[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([productId])
}

model ProductVariantOption {
  id                   String             @id @default(cuid())
  productVariantId     String
  productOptionId      String
  productOptionValueId String

  variant              ProductVariant     @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  option               ProductOption      @relation(fields: [productOptionId], references: [id], onDelete: Cascade)
  value                ProductOptionValue @relation(fields: [productOptionValueId], references: [id], onDelete: Cascade)

  @@unique([productVariantId, productOptionId])
  @@index([productOptionValueId])
}

/* ============================
   Orders (MTO)
   ============================ */
model Order {
  id                   String            @id @default(cuid())
  orderId              String            @unique
  orderNumber          String

  customerId           String?
  customerEmail        String
  customerFirstName    String?
  customerLastName     String?
  customerPhone        String?
  isGuest              Boolean           @default(false)

  customer             User?             @relation("UserOrders", fields: [customerId], references: [id], onDelete: SetNull)

  shippingAddress      Json
  billingAddress       Json

  subtotal             Int
  tax                  Int
  shippingAmount       Int
  discount             Int
  total                Int
  currency             Currency          @default(USD)

  status               OrderStatus       @default(DESIGN_RECEIVED)
  paymentStatus        PaymentStatus     @default(PENDING)
  fulfillmentStatus    FulfillmentStatus @default(UNFULFILLED)

  estimatedProductionTime Int            @default(0)
  actualProductionTime     Int?
  productionStartDate      DateTime?
  productionEndDate        DateTime?
  qualityCheckDate         DateTime?
  manufacturingNotes       String?

  designReceivedAt      DateTime @default(now())
  productionStartedAt   DateTime?
  productionCompletedAt DateTime?
  shippedAt             DateTime?
  deliveredAt           DateTime?

  items                 OrderItem[]
  shipment              OrderShipment?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([customerEmail])
  @@index([status, createdAt])
}

model OrderItem {
  id               String  @id @default(cuid())
  orderId          String
  productId        String?
  productTitle     String
  sku              String?
  quantity         Int

  price            Int
  totalPrice       Int

  // Variant linkage (attributes → SKU)
  productVariantId String?
  variant          ProductVariant? @relation(fields: [productVariantId], references: [id], onDelete: SetNull)

  // Chosen high-level option pointers (optional for reporting)
  styleId          String?
  soleId           String?
  sizeId           String?

  // Panel-level customization snapshot
  panelCustomization Json

  // 3D design snapshot
  designGlbUrl      String?
  designThumbnail   String?
  designConfig      Json?

  order            Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product?   @relation(fields: [productId], references: [id], onDelete: SetNull)
  style            Style?     @relation(fields: [styleId], references: [id], onDelete: SetNull)
  sole             Sole?      @relation(fields: [soleId], references: [id], onDelete: SetNull)
  size             Size?      @relation(fields: [sizeId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([productVariantId])
}

model OrderShipment {
  id                String         @id @default(cuid())
  orderId           String @unique
  provider          String         @default("shiprocket")
  providerOrderId   String?
  awbNumber         String?
  courierName       String?
  courierId         String?
  trackingUrl       String?
  labelUrl          String?
  status            ShipmentStatus @default(PENDING)
  estimatedDelivery DateTime?
  actualDelivery    DateTime?

  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

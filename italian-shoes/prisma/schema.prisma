generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// *
///  * ============================
///  * Auth (NextAuth-compatible)
///  * ============================
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  orders        Order[]   @relation("UserOrders")
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// *
///  * ============================
///  * Master Data
///  * ============================
model Material {
  id          String          @id @unique @default(cuid())
  name        String
  description String?
  category    String
  isActive    Boolean         @default(true)
  extId       Int?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  colors      MaterialColor[]
}

model MaterialColor {
  id         String   @id @default(cuid())
  materialId String
  name       String
  colorCode  String?
  family     String?
  hexCode    String?
  imageUrl   String?
  isActive   Boolean  @default(true)
  extId      Int?
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([name])
}

model Style {
  id          String      @id @unique @default(cuid())
  name        String
  description String?
  category    String?
  isActive    Boolean     @default(true)
  imageUrl    String?
  glbUrl      String?
  lighting    Json?
  environment Json?
  assets      Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orderItems  OrderItem[] @relation("OrderItemStyle")
}

model Sole {
  id          String      @id @unique @default(cuid())
  name        String
  description String?
  category    String?
  isActive    Boolean     @default(true)
  imageUrl    String?
  glbUrl      String?
  lighting    Json?
  environment Json?
  assets      Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orderItems  OrderItem[] @relation("OrderItemSole")
}

model Size {
  id           String      @id @unique @default(cuid())
  name         String
  region       Region
  value        Float
  euEquivalent String?
  ukEquivalent String?
  isActive     Boolean     @default(true)
  sortOrder    Int         @default(0)
  extId        Int?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  orderItems   OrderItem[] @relation("OrderItemSize")
}

model Panel {
  id        String      @id @default(cuid())
  panelId   String      @unique
  name      String
  group     PanelGroup?
  sortOrder Int         @default(0)
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

/// *
///  * ============================
///  * Product Catalog
///  * ============================
model Product {
  id                String   @id @default(cuid())
  productId         String   @unique
  title             String
  vendor            String?
  description       String?
  metaTitle         String?
  metaDescription   String?
  metaKeywords      String?
  price             Int
  currency          Currency @default(INR)
  compareAtPrice    Int?
  assets            Json?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  selectedMaterials Json?
  selectedSoles     Json?
  selectedStyles    Json?

  @@index([title])
  @@index([productId])
}

/// *
///  * ============================
///  * Orders (MTO)
///  * ============================
model Order {
  id                      String            @id @default(cuid())
  orderId                 String            @unique
  orderNumber             String
  customerId              String?
  customerEmail           String
  customerFirstName       String?
  customerLastName        String?
  customerPhone           String?
  isGuest                 Boolean           @default(false)
  shippingAddress         Json
  billingAddress          Json
  subtotal                Int
  tax                     Int
  shippingAmount          Int
  discount                Int
  total                   Int
  currency                Currency          @default(USD)
  status                  OrderStatus       @default(DESIGN_RECEIVED)
  paymentStatus           PaymentStatus     @default(PENDING)
  fulfillmentStatus       FulfillmentStatus @default(UNFULFILLED)
  estimatedProductionTime Int               @default(0)
  actualProductionTime    Int?
  productionStartDate     DateTime?
  productionEndDate       DateTime?
  qualityCheckDate        DateTime?
  manufacturingNotes      String?
  designReceivedAt        DateTime          @default(now())
  productionStartedAt     DateTime?
  productionCompletedAt   DateTime?
  shippedAt               DateTime?
  deliveredAt             DateTime?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  customer                User?             @relation("UserOrders", fields: [customerId], references: [id])
  items                   OrderItem[]
  shipment                OrderShipment?

  @@index([customerEmail])
  @@index([status, createdAt])
}

model OrderItem {
  id                 String  @id @default(cuid())
  orderId            String
  productId          String?
  productTitle       String
  sku                String?
  quantity           Int
  price              Int
  totalPrice         Int
  productVariantId   String?
  styleId            String?
  soleId             String?
  sizeId             String?
  panelCustomization Json
  designGlbUrl       String?
  designThumbnail    String?
  designConfig       Json?
  order              Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  size               Size?   @relation("OrderItemSize", fields: [sizeId], references: [id])
  sole               Sole?   @relation("OrderItemSole", fields: [soleId], references: [id])
  style              Style?  @relation("OrderItemStyle", fields: [styleId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productVariantId])
}

model OrderShipment {
  id                String         @id @default(cuid())
  orderId           String         @unique
  provider          String         @default("shiprocket")
  providerOrderId   String?
  awbNumber         String?
  courierName       String?
  courierId         String?
  trackingUrl       String?
  labelUrl          String?
  status            ShipmentStatus @default(PENDING)
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

/// *
///  * ============================
///  * Enums
///  * ============================
enum Role {
  USER
  ADMIN
}

enum Currency {
  USD
  EUR
  GBP
  INR
}

enum Region {
  US
  EU
  UK
}

enum PanelGroup {
  FRONT
  SIDE
  BACK
  TOP
  SOLE
  LINING
}

enum OrderStatus {
  DESIGN_RECEIVED
  IN_PRODUCTION
  QUALITY_CHECK
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  IN_PRODUCTION
  READY_TO_SHIP
  SHIPPED
  DELIVERED
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum ShoeWidth {
  STANDARD
  WIDE
  EXTRA_WIDE
  NARROW
}

enum OptionType {
  SIZE
  WIDTH
  STYLE
  SOLE
  COLOR
  MATERIAL
  CUSTOM
}
